<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>像素僵尸生存战</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind (精简配置) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#22c55e',
            secondary: '#ef4444',
            dark: '#1f2937',
            light: '#f3f4f6',
          },
          fontFamily: {
            pixel: ['"Press Start 2P"', 'cursive', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .pixel-border {
        box-shadow: 0 -4px 0 4px theme('colors.dark'), 
                    4px 0 0 4px theme('colors.dark'), 
                    0 4px 0 4px theme('colors.dark'), 
                    -4px 0 0 4px theme('colors.dark');
      }
      .pixel-button {
        @apply bg-primary hover:bg-primary/80 text-light font-pixel py-2 px-4 transition-all duration-150 active:scale-95;
        box-shadow: 0 -4px 0 0 #15803d inset, 
                    4px 0 0 0 #15803d inset, 
                    0 4px 0 0 #15803d inset, 
                    -4px 0 0 0 #15803d inset;
      }
      .pixel-button-danger {
        @apply bg-secondary hover:bg-secondary/80 text-light font-pixel py-2 px-4 transition-all duration-150 active:scale-95;
        box-shadow: 0 -4px 0 0 #b91c1c inset, 
                    4px 0 0 0 #b91c1c inset, 
                    0 4px 0 0 #b91c1c inset, 
                    -4px 0 0 0 #b91c1c inset;
      }
      .game-title {
        text-shadow: 4px 4px 0 #000;
      }
      .pixel-text {
        text-shadow: 2px 2px 0 #000;
      }
    }
  </style>
  
  <!-- 像素字体 (预加载) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>

<body class="bg-dark text-light min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden">
  <!-- 游戏容器 -->
  <div class="relative w-full max-w-4xl flex flex-col items-center">
    
    <!-- 游戏标题 -->
    <h1 class="text-[clamp(1.5rem,5vw,2.5rem)] font-pixel text-primary game-title mb-4 text-center">像素僵尸生存战</h1>
    
    <!-- 游戏信息栏 -->
    <div class="w-full flex justify-between items-center mb-3 px-2">
      <div class="font-pixel text-sm md:text-base flex items-center gap-2">
        <i class="fa fa-heart text-secondary"></i>
        <span id="health" class="pixel-text">100</span>
      </div>
      <div class="font-pixel text-sm md:text-base flex items-center gap-2">
        <i class="fa fa-star text-yellow-400"></i>
        <span id="score" class="pixel-text">0</span>
      </div>
      <div class="font-pixel text-sm md:text-base flex items-center gap-2">
        <i class="fa fa-clock-o text-blue-400"></i>
        <span id="timer" class="pixel-text">0</span>
      </div>
    </div>
    
    <!-- 游戏画布容器 -->
    <div class="relative w-full aspect-[4/3] bg-[#4b5563] pixel-border overflow-hidden">
      <canvas id="gameCanvas" class="w-full h-full"></canvas>
      
      <!-- 开始屏幕 -->
      <div id="startScreen" class="absolute inset-0 bg-dark/80 flex flex-col items-center justify-center gap-6 z-10">
        <h2 class="text-2xl md:text-3xl font-pixel text-primary text-center px-4">准备战斗!</h2>
        <p class="text-center font-pixel text-sm px-4 max-w-md">控制你的角色，消灭来袭的僵尸，生存时间越长，得分越高!</p>
        <div class="flex flex-col sm:flex-row gap-4">
          <button id="startButton" class="pixel-button">
            <i class="fa fa-play mr-2"></i>开始游戏
          </button>
          <button id="howToPlayButton" class="pixel-button">
            <i class="fa fa-question mr-2"></i>游戏说明
          </button>
        </div>
      </div>
      
      <!-- 游戏结束屏幕 -->
      <div id="gameOverScreen" class="absolute inset-0 bg-dark/80 flex flex-col items-center justify-center gap-6 z-10 hidden">
        <h2 class="text-2xl md:text-3xl font-pixel text-secondary text-center">游戏结束</h2>
        <p class="font-pixel text-lg">最终得分: <span id="finalScore" class="text-primary">0</span></p>
        <p class="font-pixel text-lg">生存时间: <span id="finalTime" class="text-primary">0</span>秒</p>
        <button id="restartButton" class="pixel-button">
          <i class="fa fa-refresh mr-2"></i>再来一次
        </button>
      </div>
      
      <!-- 游戏说明屏幕 -->
      <div id="instructionsScreen" class="absolute inset-0 bg-dark/90 flex flex-col items-center justify-center gap-6 z-10 hidden p-4">
        <h2 class="text-2xl font-pixel text-primary text-center">游戏说明</h2>
        <div class="font-pixel text-sm md:text-base max-w-md space-y-4">
          <p><i class="fa fa-arrows text-primary mr-2"></i>使用方向键或WASD移动角色</p>
          <p><i class="fa fa-mouse-pointer text-primary mr-2"></i>点击鼠标射击僵尸</p>
          <p><i class="fa fa-bolt text-primary mr-2"></i>消灭僵尸获得分数</p>
          <p><i class="fa fa-heart-o text-primary mr-2"></i>被僵尸碰到会损失生命值</p>
          <p><i class="fa fa-medkit text-primary mr-2"></i>偶尔会出现医疗包恢复生命值</p>
        </div>
        <button id="backButton" class="pixel-button-danger">
          <i class="fa fa-arrow-left mr-2"></i>返回
        </button>
      </div>
    </div>
    
    <!-- 移动设备控制按钮 -->
    <div class="md:hidden grid grid-cols-3 gap-2 mt-4 w-full max-w-xs">
      <div></div>
      <button id="upBtn" class="pixel-button flex items-center justify-center">
        <i class="fa fa-arrow-up"></i>
      </button>
      <div></div>
      <button id="leftBtn" class="pixel-button flex items-center justify-center">
        <i class="fa fa-arrow-left"></i>
      </button>
      <button id="downBtn" class="pixel-button flex items-center justify-center">
        <i class="fa fa-arrow-down"></i>
      </button>
      <button id="rightBtn" class="pixel-button flex items-center justify-center">
        <i class="fa fa-arrow-right"></i>
      </button>
    </div>
    
    <!-- 游戏控制区 -->
    <div class="mt-4 flex flex-wrap gap-3 justify-center">
      <button id="pauseButton" class="pixel-button hidden">
        <i class="fa fa-pause mr-2"></i>暂停
      </button>
      <button id="resumeButton" class="pixel-button hidden">
        <i class="fa fa-play mr-2"></i>继续
      </button>
      <button id="soundButton" class="pixel-button">
        <i class="fa fa-volume-up mr-2"></i>音效
      </button>
    </div>
  </div>

  <script>
    // 游戏主逻辑 - 优化版
    document.addEventListener('DOMContentLoaded', () => {
      // DOM元素缓存
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const startScreen = document.getElementById('startScreen');
      const gameOverScreen = document.getElementById('gameOverScreen');
      const instructionsScreen = document.getElementById('instructionsScreen');
      const startButton = document.getElementById('startButton');
      const restartButton = document.getElementById('restartButton');
      const howToPlayButton = document.getElementById('howToPlayButton');
      const backButton = document.getElementById('backButton');
      const pauseButton = document.getElementById('pauseButton');
      const resumeButton = document.getElementById('resumeButton');
      const soundButton = document.getElementById('soundButton');
      const healthDisplay = document.getElementById('health');
      const scoreDisplay = document.getElementById('score');
      const timerDisplay = document.getElementById('timer');
      const finalScoreDisplay = document.getElementById('finalScore');
      const finalTimeDisplay = document.getElementById('finalTime');
      
      // 移动控制按钮
      const upBtn = document.getElementById('upBtn');
      const downBtn = document.getElementById('downBtn');
      const leftBtn = document.getElementById('leftBtn');
      const rightBtn = document.getElementById('rightBtn');
      
      // 性能优化：缓存画布尺寸
      let canvasWidth, canvasHeight;
      
      // 离屏Canvas用于绘制静态背景
      const bgCanvas = document.createElement('canvas');
      const bgCtx = bgCanvas.getContext('2d');
      
      // 设置画布尺寸 - 优化版
      function resizeCanvas() {
        const container = canvas.parentElement;
        canvasWidth = container.clientWidth;
        canvasHeight = container.clientHeight;
        
        // 同步主画布和背景画布尺寸
        [canvas, bgCanvas].forEach(can => {
          can.width = canvasWidth;
          can.height = canvasHeight;
        });
        
        // 重新绘制背景
        drawBackground();
        
        // 如果游戏正在运行，重新定位玩家
        if (gameState.isRunning) {
          player.x = canvasWidth / 2;
          player.y = canvasHeight / 2;
        }
      }
      
      // 绘制静态背景 - 只绘制一次
      function drawBackground() {
        bgCtx.fillStyle = '#4b5563';
        bgCtx.fillRect(0, 0, canvasWidth, canvasHeight);
        
        // 绘制像素网格（轻微装饰）
        bgCtx.fillStyle = '#374151';
        const gridSize = 30;
        for (let x = 0; x < canvasWidth; x += gridSize) {
          for (let y = 0; y < canvasHeight; y += gridSize) {
            bgCtx.fillRect(x, y, 1, 1);
          }
        }
      }
      
      // 初始化调整大小并监听窗口变化
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      // 对象池 - 减少垃圾回收
      const zombiePool = [];
      const bulletPool = [];
      const medkitPool = [];
      
      // 获取对象池中的对象
      function getZombie() {
        return zombiePool.length > 0 ? zombiePool.pop() : {
          x: 0, y: 0, size: 18, color: '#ef4444', isDead: false
        };
      }
      
      function getBullet() {
        return bulletPool.length > 0 ? bulletPool.pop() : {
          x: 0, y: 0, size: 4, speed: 0, dx: 0, dy: 0, color: '#fbbf24', isActive: false
        };
      }
      
      function getMedkit() {
        return medkitPool.length > 0 ? medkitPool.pop() : {
          x: 0, y: 0, size: 15, color: '#3b82f6', isActive: false, timer: 0
        };
      }
      
      // 回收对象到对象池
      function releaseZombie(zombie) {
        zombie.isDead = true;
        zombiePool.push(zombie);
      }
      
      function releaseBullet(bullet) {
        bullet.isActive = false;
        bulletPool.push(bullet);
      }
      
      function releaseMedkit(medkit) {
        medkit.isActive = false;
        medkitPool.push(medkit);
      }
      
      // 游戏状态
      let gameState = {
        isRunning: false,
        isPaused: false,
        score: 0,
        health: 100,
        time: 0,
        soundEnabled: true,
        lastZombieSpawn: 0,
        zombieSpawnRate: 1500, // 毫秒
        lastMedkitSpawn: 0,
        medkitSpawnRate: 15000, // 毫秒
        lastCollisionCheck: 0,
        collisionCheckInterval: 100, // 每100ms检测一次碰撞
        playerSpeed: 5,
        zombieSpeed: 2,
        bulletSpeed: 8,
        keys: {
          up: false,
          down: false,
          left: false,
          right: false
        }
      };
      
      // 玩家
      const player = {
        x: 0,
        y: 0,
        size: 20,
        color: '#22c55e' // 绿色
      };
      
      // 游戏对象数组
      let bullets = [];
      let zombies = [];
      let medkits = [];
      
      // 音效（延迟加载）
      let shootSound, hitSound, powerupSound;
      
      // 预加载音效
      function preloadSounds() {
        if (gameState.soundEnabled) {
          shootSound = new Audio('data:audio/wav;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQBAAD');
          hitSound = new Audio('data:audio/wav;base64,UklGRiQBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQBAAD');
          powerupSound = new Audio('data:audio/wav;base64,UklGRngBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQBAAD');
        }
      }
      
      // 播放音效
      function playSound(sound) {
        if (gameState.soundEnabled && sound) {
          sound.currentTime = 0;
          sound.play().catch(e => console.log('音效播放失败:', e));
        }
      }
      
      // 初始化游戏
      function initGame() {
        // 重置游戏状态
        gameState.score = 0;
        gameState.health = 100;
        gameState.time = 0;
        gameState.lastZombieSpawn = Date.now();
        gameState.lastMedkitSpawn = Date.now();
        
        // 重置玩家位置
        player.x = canvasWidth / 2;
        player.y = canvasHeight / 2;
        
        // 清空并回收对象
        zombies.forEach(z => releaseZombie(z));
        bullets.forEach(b => releaseBullet(b));
        medkits.forEach(m => releaseMedkit(m));
        zombies = [];
        bullets = [];
        medkits = [];
        
        // 更新UI
        updateUI();
        
        // 预加载音效
        preloadSounds();
      }
      
      // 更新游戏状态
      function update() {
        if (gameState.isPaused) return;
        
        // 更新时间
        gameState.time = Math.floor((Date.now() - gameState.startTime) / 1000);
        timerDisplay.textContent = gameState.time;
        
        // 移动玩家
        movePlayer();
        
        // 生成僵尸
        spawnZombies();
        
        // 生成医疗包
        spawnMedkits();
        
        // 移动僵尸
        moveZombies();
        
        // 移动子弹
        moveBullets();
        
        // 更新医疗包
        updateMedkits();
        
        // 定期检测碰撞（不是每帧都检测）
        const now = Date.now();
        if (now - gameState.lastCollisionCheck > gameState.collisionCheckInterval) {
          checkCollisions();
          gameState.lastCollisionCheck = now;
        }
        
        // 检查游戏结束
        if (gameState.health <= 0) {
          endGame();
        }
      }
      
      // 移动玩家
      function movePlayer() {
        if (gameState.keys.up && player.y > player.size / 2) {
          player.y -= gameState.playerSpeed;
        }
        if (gameState.keys.down && player.y < canvasHeight - player.size / 2) {
          player.y += gameState.playerSpeed;
        }
        if (gameState.keys.left && player.x > player.size / 2) {
          player.x -= gameState.playerSpeed;
        }
        if (gameState.keys.right && player.x < canvasWidth - player.size / 2) {
          player.x += gameState.playerSpeed;
        }
      }
      
      // 生成僵尸
      function spawnZombies() {
        const now = Date.now();
        if (now - gameState.lastZombieSpawn > gameState.zombieSpawnRate) {
          const zombie = getZombie();
          
          // 随机在屏幕边缘生成
          const side = Math.floor(Math.random() * 4);
          switch (side) {
            case 0: // 顶部
              zombie.x = Math.random() * canvasWidth;
              zombie.y = -zombie.size;
              break;
            case 1: // 右侧
              zombie.x = canvasWidth + zombie.size;
              zombie.y = Math.random() * canvasHeight;
              break;
            case 2: // 底部
              zombie.x = Math.random() * canvasWidth;
              zombie.y = canvasHeight + zombie.size;
              break;
            case 3: // 左侧
              zombie.x = -zombie.size;
              zombie.y = Math.random() * canvasHeight;
              break;
          }
          
          zombie.isDead = false;
          zombies.push(zombie);
          gameState.lastZombieSpawn = now;
          
          // 随着时间增加难度
          gameState.zombieSpawnRate = Math.max(500, 1500 - (gameState.time * 10));
          gameState.zombieSpeed = Math.min(4, 2 + (gameState.time * 0.05));
        }
      }
      
      // 生成医疗包
      function spawnMedkits() {
        const now = Date.now();
        if (now - gameState.lastMedkitSpawn > gameState.medkitSpawnRate && gameState.health < 80) {
          const medkit = getMedkit();
          medkit.x = Math.random() * (canvasWidth - medkit.size * 2) + medkit.size;
          medkit.y = Math.random() * (canvasHeight - medkit.size * 2) + medkit.size;
          medkit.isActive = true;
          medkit.timer = 10000; // 10秒后消失
          medkits.push(medkit);
          gameState.lastMedkitSpawn = now;
        }
      }
      
      // 移动僵尸（追踪玩家）
      function moveZombies() {
        for (let i = zombies.length - 1; i >= 0; i--) {
          const zombie = zombies[i];
          if (zombie.isDead) {
            zombies.splice(i, 1);
            continue;
          }
          
          // 计算朝向玩家的方向
          const dx = player.x - zombie.x;
          const dy = player.y - zombie.y;
          const distance = Math.sqrt(dx * dx + dy * dy);
          
          // 移动僵尸
          if (distance > 0) {
            zombie.x += (dx / distance) * gameState.zombieSpeed;
            zombie.y += (dy / distance) * gameState.zombieSpeed;
          }
        }
      }
      
      // 移动子弹
      function moveBullets() {
        for (let i = bullets.length - 1; i >= 0; i--) {
          const bullet = bullets[i];
          if (!bullet.isActive) {
            bullets.splice(i, 1);
            continue;
          }
          
          // 移动子弹
          bullet.x += bullet.dx;
          bullet.y += bullet.dy;
          
          // 子弹出界则回收
          if (bullet.x < 0 || bullet.x > canvasWidth || bullet.y < 0 || bullet.y > canvasHeight) {
            releaseBullet(bullet);
            bullets.splice(i, 1);
          }
        }
      }
      
      // 更新医疗包
      function updateMedkits() {
        const now = Date.now();
        for (let i = medkits.length - 1; i >= 0; i--) {
          const medkit = medkits[i];
          if (!medkit.isActive) {
            medkits.splice(i, 1);
            continue;
          }
          
          // 医疗包超时消失
          medkit.timer -= 16; // 假设每帧约16ms
          if (medkit.timer <= 0) {
            releaseMedkit(medkit);
            medkits.splice(i, 1);
          }
        }
      }
      
      // 检查碰撞
      function checkCollisions() {
        // 子弹与僵尸碰撞
        for (let i = bullets.length - 1; i >= 0; i--) {
          const bullet = bullets[i];
          if (!bullet.isActive) continue;
          
          for (let j = zombies.length - 1; j >= 0; j--) {
            const zombie = zombies[j];
            if (zombie.isDead) continue;
            
            if (checkRectCollision(bullet, zombie)) {
              // 僵尸被击中
              playSound(hitSound);
              releaseBullet(bullet);
              bullets.splice(i, 1);
              releaseZombie(zombie);
              zombies.splice(j, 1);
              
              // 增加分数
              gameState.score += 10;
              scoreDisplay.textContent = gameState.score;
              break;
            }
          }
        }
        
        // 玩家与僵尸碰撞
        for (let i = zombies.length - 1; i >= 0; i--) {
          const zombie = zombies[i];
          if (zombie.isDead) continue;
          
          if (checkRectCollision(player, zombie)) {
            // 玩家受伤
            gameState.health = Math.max(0, gameState.health - 5);
            healthDisplay.textContent = gameState.health;
            playSound(hitSound);
            
            // 僵尸被推开并销毁
            releaseZombie(zombie);
            zombies.splice(i, 1);
          }
        }
        
        // 玩家与医疗包碰撞
        for (let i = medkits.length - 1; i >= 0; i--) {
          const medkit = medkits[i];
          if (!medkit.isActive) continue;
          
          if (checkRectCollision(player, medkit)) {
            // 恢复生命值
            playSound(powerupSound);
            gameState.health = Math.min(100, gameState.health + 30);
            healthDisplay.textContent = gameState.health;
            
            releaseMedkit(medkit);
            medkits.splice(i, 1);
          }
        }
      }
      
      // 矩形碰撞检测（优化版）
      function checkRectCollision(rect1, rect2) {
        const halfSize1 = rect1.size / 2;
        const halfSize2 = rect2.size / 2;
        
        return rect1.x - halfSize1 < rect2.x + halfSize2 &&
               rect1.x + halfSize1 > rect2.x - halfSize2 &&
               rect1.y - halfSize1 < rect2.y + halfSize2 &&
               rect1.y + halfSize1 > rect2.y - halfSize2;
      }
      
      // 射击
      function shoot(targetX, targetY) {
        if (!gameState.isRunning || gameState.isPaused) return;
        
        const bullet = getBullet();
        bullet.x = player.x;
        bullet.y = player.y;
        
        // 计算子弹方向
        const dx = targetX - canvas.getBoundingClientRect().left - player.x;
        const dy = targetY - canvas.getBoundingClientRect().top - player.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // 设置子弹速度
        bullet.dx = (dx / distance) * gameState.bulletSpeed;
        bullet.dy = (dy / distance) * gameState.bulletSpeed;
        bullet.isActive = true;
        
        bullets.push(bullet);
        playSound(shootSound);
      }
      
      // 更新UI
      function updateUI() {
        healthDisplay.textContent = gameState.health;
        scoreDisplay.textContent = gameState.score;
        timerDisplay.textContent = gameState.time;
      }
      
      // 渲染游戏
      function render() {
        // 绘制背景（复用离屏Canvas）
        ctx.drawImage(bgCanvas, 0, 0);
        
        // 绘制玩家（像素风格）
        drawPixelRect(player.x, player.y, player.size, player.color);
        
        // 绘制子弹
        bullets.forEach(bullet => {
          if (bullet.isActive) {
            drawPixelRect(bullet.x, bullet.y, bullet.size, bullet.color);
          }
        });
        
        // 绘制僵尸
        zombies.forEach(zombie => {
          if (!zombie.isDead) {
            drawPixelRect(zombie.x, zombie.y, zombie.size, zombie.color);
          }
        });
        
        // 绘制医疗包（闪烁效果）
        medkits.forEach(medkit => {
          if (medkit.isActive && Math.floor(Date.now() / 300) % 2 === 0) {
            drawPixelRect(medkit.x, medkit.y, medkit.size, medkit.color);
          }
        });
      }
      
      // 绘制像素风格的矩形
      function drawPixelRect(x, y, size, color) {
        const halfSize = size / 2;
        ctx.fillStyle = color;
        ctx.fillRect(x - halfSize, y - halfSize, size, size);
        
        // 像素边框
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 1;
        ctx.strokeRect(x - halfSize, y - halfSize, size, size);
      }
      
      // 游戏主循环（使用requestAnimationFrame优化性能）
      function gameLoop() {
        if (gameState.isRunning) {
          update();
          render();
        }
        requestAnimationFrame(gameLoop);
      }
      
      // 开始游戏
      function startGame() {
        initGame();
        gameState.isRunning = true;
        gameState.isPaused = false;
        gameState.startTime = Date.now();
        
        // 显示/隐藏UI元素
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        pauseButton.classList.remove('hidden');
        resumeButton.classList.add('hidden');
      }
      
      // 结束游戏
      function endGame() {
        gameState.isRunning = false;
        
        // 更新结束界面
        finalScoreDisplay.textContent = gameState.score;
        finalTimeDisplay.textContent = gameState.time;
        
        // 显示/隐藏UI元素
        gameOverScreen.classList.remove('hidden');
        pauseButton.classList.add('hidden');
        resumeButton.classList.add('hidden');
      }
      
      // 暂停/继续游戏
      function togglePause() {
        gameState.isPaused = !gameState.isPaused;
        pauseButton.classList.toggle('hidden', gameState.isPaused);
        resumeButton.classList.toggle('hidden', !gameState.isPaused);
      }
      
      // 切换音效
      function toggleSound() {
        gameState.soundEnabled = !gameState.soundEnabled;
        soundButton.innerHTML = gameState.soundEnabled ? 
          '<i class="fa fa-volume-up mr-2"></i>音效' : 
          '<i class="fa fa-volume-off mr-2"></i>音效';
        preloadSounds();
      }
      
      // 事件监听
      startButton.addEventListener('click', startGame);
      restartButton.addEventListener('click', startGame);
      howToPlayButton.addEventListener('click', () => {
        startScreen.classList.add('hidden');
        instructionsScreen.classList.remove('hidden');
      });
      backButton.addEventListener('click', () => {
        instructionsScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
      });
      pauseButton.addEventListener('click', togglePause);
      resumeButton.addEventListener('click', togglePause);
      soundButton.addEventListener('click', toggleSound);
      
      // 鼠标射击
      canvas.addEventListener('click', (e) => {
        shoot(e.clientX, e.clientY);
      });
      
      // 触摸屏射击
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (e.touches.length > 0) {
          shoot(e.touches[0].clientX, e.touches[0].clientY);
        }
      }, { passive: false });
      
      // 键盘控制
      window.addEventListener('keydown', (e) => {
        switch(e.key) {
          case 'ArrowUp':
          case 'w':
          case 'W':
            gameState.keys.up = true;
            break;
          case 'ArrowDown':
          case 's':
          case 'S':
            gameState.keys.down = true;
            break;
          case 'ArrowLeft':
          case 'a':
          case 'A':
            gameState.keys.left = true;
            break;
          case 'ArrowRight':
          case 'd':
          case 'D':
            gameState.keys.right = true;
            break;
          case ' ':
            // 空格暂停
            if (gameState.isRunning) togglePause();
            break;
        }
      });
      
      window.addEventListener('keyup', (e) => {
        switch(e.key) {
          case 'ArrowUp':
          case 'w':
          case 'W':
            gameState.keys.up = false;
            break;
          case 'ArrowDown':
          case 's':
          case 'S':
            gameState.keys.down = false;
            break;
          case 'ArrowLeft':
          case 'a':
          case 'A':
            gameState.keys.left = false;
            break;
          case 'ArrowRight':
          case 'd':
          case 'D':
            gameState.keys.right = false;
            break;
        }
      });
      
      // 移动设备按钮控制
      ['touchstart', 'mousedown'].forEach(event => {
        upBtn.addEventListener(event, () => gameState.keys.up = true);
        downBtn.addEventListener(event, () => gameState.keys.down = true);
        leftBtn.addEventListener(event, () => gameState.keys.left = true);
        rightBtn.addEventListener(event, () => gameState.keys.right = true);
      });
      
      ['touchend', 'mouseup', 'mouseleave'].forEach(event => {
        upBtn.addEventListener(event, () => gameState.keys.up = false);
        downBtn.addEventListener(event, () => gameState.keys.down = false);
        leftBtn.addEventListener(event, () => gameState.keys.left = false);
        rightBtn.addEventListener(event, () => gameState.keys.right = false);
      });
      
      // 开始游戏循环
      gameLoop();
    });
  </script>
</body>
</html>
